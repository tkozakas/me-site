x-backend: &backend
  ports:
    - "8080:8080"
  environment:
    - GITHUB_TOKEN=${GITHUB_TOKEN}
    - GITHUB_USERNAME=${GITHUB_USERNAME:-tkozakas}
    - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
    - PORT=8080
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
    interval: 5s
    timeout: 3s
    retries: 3
    start_period: 5s

x-frontend: &frontend
  ports:
    - "3000:80"
  restart: unless-stopped

services:
  backend:
    <<: *backend
    profiles: ["dev"]
    build:
      context: ./backend
      dockerfile: Dockerfile

  backend-prod:
    <<: *backend
    profiles: ["prod"]
    image: ghcr.io/tkozakas/me-site-backend:main
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  frontend:
    <<: *frontend
    profiles: ["dev"]
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080}
    depends_on:
      backend:
        condition: service_healthy

  frontend-prod:
    <<: *frontend
    profiles: ["prod"]
    image: ghcr.io/tkozakas/me-site-frontend:main
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    depends_on:
      backend-prod:
        condition: service_healthy

  watchtower:
    profiles: ["prod"]
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_LABEL_ENABLE=true
    restart: unless-stopped
